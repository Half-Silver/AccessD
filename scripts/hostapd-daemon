#!/bin/bash
set -e

SNAP_COMMON=${SNAP_COMMON:-/var/snap/accessd/common}
CONFIG_DIR="$SNAP_COMMON/config"
ROUTER_CONF="$CONFIG_DIR/router.conf"
HOSTAPD_CONF="$CONFIG_DIR/hostapd.conf"
TEMPLATE_CONF="$SNAP/etc/accessd/hostapd.conf.template"

load_router_conf() {
  if [ ! -f "$ROUTER_CONF" ]; then
    return 0
  fi

  # shellcheck disable=SC1090
  if . "$ROUTER_CONF" 2>/dev/null; then
    return 0
  fi

  while IFS= read -r line; do
    case "$line" in
      ''|\#*)
        continue
        ;;
      *=*)
        key=${line%%=*}
        val=${line#*=}
        case "$val" in
          ""*"") val=${val#\"}; val=${val%\"} ;;
          \'.*\') val=${val#\'}; val=${val%\'} ;;
        esac
        val=${val//\\ / }
        val=${val//\\\\/\\}
        case "$key" in
          WAN_INTERFACE) WAN_INTERFACE="$val" ;;
          LAN_INTERFACE) LAN_INTERFACE="$val" ;;
          SSID) SSID="$val" ;;
          WPA_PASSPHRASE) WPA_PASSPHRASE="$val" ;;
          CHANNEL) CHANNEL="$val" ;;
          LAN_IP) LAN_IP="$val" ;;
          LAN_NETMASK) LAN_NETMASK="$val" ;;
          DHCP_START) DHCP_START="$val" ;;
          DHCP_END) DHCP_END="$val" ;;
          DHCP_LEASE) DHCP_LEASE="$val" ;;
        esac
        ;;
    esac
  done < "$ROUTER_CONF"
}

write_router_conf() {
  {
    printf 'WAN_INTERFACE=%q\n' "$WAN_INTERFACE"
    printf 'LAN_INTERFACE=%q\n' "$LAN_INTERFACE"
    printf 'SSID=%q\n' "$SSID"
    printf 'WPA_PASSPHRASE=%q\n' "$WPA_PASSPHRASE"
    printf 'CHANNEL=%q\n' "$CHANNEL"
    printf 'LAN_IP=%q\n' "$LAN_IP"
    printf 'LAN_NETMASK=%q\n' "$LAN_NETMASK"
    printf 'DHCP_START=%q\n' "$DHCP_START"
    printf 'DHCP_END=%q\n' "$DHCP_END"
    printf 'DHCP_LEASE=%q\n' "$DHCP_LEASE"
  } > "$ROUTER_CONF"
}

mkdir -p "$CONFIG_DIR"

if [ -f "$ROUTER_CONF" ]; then
  load_router_conf
else
  WAN_INTERFACE="${WAN_INTERFACE:-eth0}"
  LAN_INTERFACE="${LAN_INTERFACE:-wlan0}"
  SSID="${SSID:-WiFiRouter}"
  WPA_PASSPHRASE="${WPA_PASSPHRASE:-changeme123}"
  CHANNEL="${CHANNEL:-6}"
  LAN_IP="${LAN_IP:-192.168.50.1}"
  LAN_NETMASK="${LAN_NETMASK:-255.255.255.0}"
  DHCP_START="${DHCP_START:-192.168.50.100}"
  DHCP_END="${DHCP_END:-192.168.50.200}"
  DHCP_LEASE="${DHCP_LEASE:-12h}"

  write_router_conf
fi

if [ -f "$TEMPLATE_CONF" ]; then
  sed \
    -e "s|{{LAN_INTERFACE}}|$LAN_INTERFACE|g" \
    -e "s|{{SSID}}|$SSID|g" \
    -e "s|{{CHANNEL}}|$CHANNEL|g" \
    -e "s|{{WPA_PASSPHRASE}}|$WPA_PASSPHRASE|g" \
    "$TEMPLATE_CONF" > "$HOSTAPD_CONF"
else
  cat > "$HOSTAPD_CONF" <<EOF
interface=$LAN_INTERFACE
driver=nl80211
ssid=$SSID
hw_mode=g
channel=$CHANNEL
macaddr_acl=0
auth_algs=1
ignore_broadcast_ssid=0
wpa=2
wpa_passphrase=$WPA_PASSPHRASE
wpa_key_mgmt=WPA-PSK
wpa_pairwise=TKIP
rsn_pairwise=CCMP
EOF
fi

rfkill unblock wifi || true
ip link set "$LAN_INTERFACE" up 2>/dev/null || true

exec "$SNAP/usr/sbin/hostapd" "$HOSTAPD_CONF"
