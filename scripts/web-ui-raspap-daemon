#!/bin/bash
set -euo pipefail

SNAP="${SNAP:-/snap/accessd/current}"
SNAP_COMMON="${SNAP_COMMON:-/var/snap/accessd/common}"

ACCESSD_WEBUI_HOST="${ACCESSD_WEBUI_HOST:-}"
ACCESSD_WEBUI_PORT="${ACCESSD_WEBUI_PORT:-}"
ACCESSD_RASPAP_DISPLAY_ERRORS="${ACCESSD_RASPAP_DISPLAY_ERRORS:-0}"
ACCESSD_RASPAP_ERROR_REPORTING="${ACCESSD_RASPAP_ERROR_REPORTING:-E_ALL & ~E_DEPRECATED & ~E_WARNING & ~E_NOTICE}"

WEBROOT="${ACCESSD_WEBROOT:-$SNAP/external/accessd.webui}"
ROUTER_SCRIPT="${ACCESSD_WEBUI_ROUTER:-$SNAP/bin/web-ui-raspap-router.php}"
CONFIG_DIR="$SNAP_COMMON/config"
LEASES_DIR="$SNAP_COMMON/leases"
LOGS_DIR="$SNAP_COMMON/logs"

snapctl_get() {
  local key="$1"
  local value

  if ! command -v snapctl >/dev/null 2>&1; then
    return 1
  fi

  value="$(snapctl get "$key" 2>/dev/null || true)"
  case "$value" in
    ''|null)
      return 1
      ;;
    *)
      printf '%s\n' "$value"
      return 0
      ;;
  esac
}

if [ -z "$ACCESSD_WEBUI_HOST" ] && snap_value="$(snapctl_get web-ui.host)"; then
  ACCESSD_WEBUI_HOST="$snap_value"
fi

if [ -z "$ACCESSD_WEBUI_PORT" ] && snap_value="$(snapctl_get web-ui.port)"; then
  ACCESSD_WEBUI_PORT="$snap_value"
fi

ACCESSD_WEBUI_HOST="${ACCESSD_WEBUI_HOST:-0.0.0.0}"
ACCESSD_WEBUI_PORT="${ACCESSD_WEBUI_PORT:-8080}"

case "$ACCESSD_WEBUI_PORT" in
  ''|*[!0-9]*)
    echo "Invalid web-ui.port '$ACCESSD_WEBUI_PORT'; using 8080." >&2
    ACCESSD_WEBUI_PORT=8080
    ;;
esac

if [ "$ACCESSD_WEBUI_PORT" -gt 65535 ]; then
  echo "Invalid web-ui.port '$ACCESSD_WEBUI_PORT'; using 8080." >&2
  ACCESSD_WEBUI_PORT=8080
fi

if [ "$ACCESSD_WEBUI_PORT" -eq 0 ]; then
  echo "Invalid web-ui.port '$ACCESSD_WEBUI_PORT'; using 8080." >&2
  ACCESSD_WEBUI_PORT=8080
fi

find_php_bin() {
  local candidate

  for candidate in \
    "$SNAP/usr/bin/php" \
    "$SNAP/usr/bin/php8.4" \
    "$SNAP/usr/bin/php8.3" \
    "$SNAP/usr/bin/php8.2" \
    "$SNAP/usr/bin/php8.1"
  do
    if [ -n "$candidate" ] && [ -x "$candidate" ]; then
      printf '%s\n' "$candidate"
      return 0
    fi
  done

  candidate="$(find "$SNAP/usr/bin" -maxdepth 1 -type f -name 'php*' 2>/dev/null | sort | head -n 1 || true)"
  if [ -n "$candidate" ] && [ -x "$candidate" ]; then
    printf '%s\n' "$candidate"
    return 0
  fi

  return 1
}

PHP_BIN="$(find_php_bin || true)"
if [ -z "$PHP_BIN" ]; then
  echo "PHP runtime not found in snap at $SNAP/usr/bin" >&2
  exit 127
fi

mkdir -p "$CONFIG_DIR" "$LEASES_DIR" "$LOGS_DIR"
mkdir -p "$CONFIG_DIR/networking" "$CONFIG_DIR/api" "$CONFIG_DIR/dnsmasq.d" "$CONFIG_DIR/adblock"

if [ ! -f "$CONFIG_DIR/networking/defaults.json" ] && [ -f "$WEBROOT/config/defaults.json" ]; then
  cp "$WEBROOT/config/defaults.json" "$CONFIG_DIR/networking/defaults.json"
fi

# Some upstream pages include includes/config.php directly.
# Keep runtime resilient even if only config/config.php is tracked in source.
if [ ! -f "$WEBROOT/includes/config.php" ] && [ -f "$WEBROOT/config/config.php" ]; then
  if [ -w "$WEBROOT/includes" ]; then
    cp "$WEBROOT/config/config.php" "$WEBROOT/includes/config.php"
  else
    echo "Warning: includes/config.php missing and '$WEBROOT/includes' is not writable." >&2
  fi
fi

if [ ! -f "$CONFIG_DIR/accessd.auth" ]; then
  # Default credentials for first boot: admin / secret
  default_hash="$("$PHP_BIN" -r 'echo password_hash("secret", PASSWORD_BCRYPT);')"
  {
    echo "admin"
    echo "$default_hash"
  } > "$CONFIG_DIR/accessd.auth"
fi

export ACCESSD_WEBROOT="$WEBROOT"
export ACCESSD_RASPI_CONFIG="${ACCESSD_RASPI_CONFIG:-$CONFIG_DIR}"
export ACCESSD_RASPI_CONFIG_NETWORK="${ACCESSD_RASPI_CONFIG_NETWORK:-$CONFIG_DIR/networking/defaults.json}"
export ACCESSD_RASPI_CONFIG_API="${ACCESSD_RASPI_CONFIG_API:-$CONFIG_DIR/api}"
export ACCESSD_RASPI_ADMIN_DETAILS="${ACCESSD_RASPI_ADMIN_DETAILS:-$CONFIG_DIR/accessd.auth}"
export ACCESSD_RASPI_DNSMASQ_LEASES="${ACCESSD_RASPI_DNSMASQ_LEASES:-$LEASES_DIR/dnsmasq.leases}"
export ACCESSD_RASPI_DNSMASQ_PREFIX="${ACCESSD_RASPI_DNSMASQ_PREFIX:-$CONFIG_DIR/dnsmasq.d/090_}"
export ACCESSD_RASPI_ADBLOCK_LISTPATH="${ACCESSD_RASPI_ADBLOCK_LISTPATH:-$CONFIG_DIR/adblock/}"
export ACCESSD_RASPI_ADBLOCK_CONFIG="${ACCESSD_RASPI_ADBLOCK_CONFIG:-$CONFIG_DIR/dnsmasq.d/090_adblock.conf}"
export ACCESSD_RASPI_HOSTAPD_CONFIG="${ACCESSD_RASPI_HOSTAPD_CONFIG:-$CONFIG_DIR/hostapd.conf}"
export ACCESSD_RASPI_DHCPCD_CONFIG="${ACCESSD_RASPI_DHCPCD_CONFIG:-$CONFIG_DIR/dhcpcd.conf}"
export ACCESSD_RASPI_DHCPCD_LOG="${ACCESSD_RASPI_DHCPCD_LOG:-$LOGS_DIR/dnsmasq.log}"
export ACCESSD_RASPI_WPA_SUPPLICANT_CONFIG="${ACCESSD_RASPI_WPA_SUPPLICANT_CONFIG:-$CONFIG_DIR/wpa_supplicant.conf}"
export ACCESSD_RASPI_OPENVPN_CLIENT_PATH="${ACCESSD_RASPI_OPENVPN_CLIENT_PATH:-$CONFIG_DIR/openvpn/client/}"
export ACCESSD_RASPI_OPENVPN_CLIENT_CONFIG="${ACCESSD_RASPI_OPENVPN_CLIENT_CONFIG:-$CONFIG_DIR/openvpn/client/client.conf}"
export ACCESSD_RASPI_OPENVPN_CLIENT_LOGIN="${ACCESSD_RASPI_OPENVPN_CLIENT_LOGIN:-$CONFIG_DIR/openvpn/client/login.conf}"
export ACCESSD_RASPI_WIREGUARD_PATH="${ACCESSD_RASPI_WIREGUARD_PATH:-$CONFIG_DIR/wireguard/}"
export ACCESSD_RASPI_WIREGUARD_CONFIG="${ACCESSD_RASPI_WIREGUARD_CONFIG:-$CONFIG_DIR/wireguard/wg0.conf}"
export ACCESSD_RASPI_IPTABLES_CONF="${ACCESSD_RASPI_IPTABLES_CONF:-$CONFIG_DIR/networking/iptables_rules.json}"
export ACCESSD_RASPI_LIGHTTPD_CONFIG="${ACCESSD_RASPI_LIGHTTPD_CONFIG:-$CONFIG_DIR/lighttpd.conf}"
export ACCESSD_RASPI_PHP_BIN="$PHP_BIN"

exec "$PHP_BIN" \
  -d "display_errors=${ACCESSD_RASPAP_DISPLAY_ERRORS}" \
  -d "error_reporting=${ACCESSD_RASPAP_ERROR_REPORTING}" \
  -S "${ACCESSD_WEBUI_HOST}:${ACCESSD_WEBUI_PORT}" \
  -t "$WEBROOT" \
  "$ROUTER_SCRIPT"
