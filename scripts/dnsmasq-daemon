#!/bin/bash
set -e

SNAP_COMMON=${SNAP_COMMON:-/var/snap/accessd/common}
CONFIG_DIR="$SNAP_COMMON/config"
LEASES_DIR="$SNAP_COMMON/leases"
LOGS_DIR="$SNAP_COMMON/logs"
ROUTER_CONF="$CONFIG_DIR/router.conf"
DNSMASQ_CONF="$CONFIG_DIR/dnsmasq.conf"
TEMPLATE_CONF="$SNAP/etc/accessd/dnsmasq.conf.template"

snapctl_get() {
  local key="$1"
  local value

  if ! command -v snapctl >/dev/null 2>&1; then
    return 1
  fi

  value="$(snapctl get "$key" 2>/dev/null || true)"
  case "$value" in
    ''|null)
      return 1
      ;;
    *)
      printf '%s\n' "$value"
      return 0
      ;;
  esac
}

load_router_conf() {
  if [ ! -f "$ROUTER_CONF" ]; then
    return 0
  fi

  # shellcheck disable=SC1090
  if . "$ROUTER_CONF" 2>/dev/null; then
    return 0
  fi

  while IFS= read -r line; do
    case "$line" in
      ''|\#*)
        continue
        ;;
      *=*)
        key=${line%%=*}
        val=${line#*=}
        case "$val" in
          ""*"") val=${val#\"}; val=${val%\"} ;;
          \'.*\') val=${val#\'}; val=${val%\'} ;;
        esac
        val=${val//\\ / }
        val=${val//\\\\/\\}
        case "$key" in
          WAN_INTERFACE) WAN_INTERFACE="$val" ;;
          LAN_INTERFACE) LAN_INTERFACE="$val" ;;
          SSID) SSID="$val" ;;
          WPA_PASSPHRASE) WPA_PASSPHRASE="$val" ;;
          CHANNEL) CHANNEL="$val" ;;
          LAN_IP) LAN_IP="$val" ;;
          LAN_NETMASK) LAN_NETMASK="$val" ;;
          DHCP_START) DHCP_START="$val" ;;
          DHCP_END) DHCP_END="$val" ;;
          DHCP_LEASE) DHCP_LEASE="$val" ;;
        esac
        ;;
    esac
  done < "$ROUTER_CONF"
}

write_router_conf() {
  {
    printf 'WAN_INTERFACE=%q\n' "$WAN_INTERFACE"
    printf 'LAN_INTERFACE=%q\n' "$LAN_INTERFACE"
    printf 'SSID=%q\n' "$SSID"
    printf 'WPA_PASSPHRASE=%q\n' "$WPA_PASSPHRASE"
    printf 'CHANNEL=%q\n' "$CHANNEL"
    printf 'LAN_IP=%q\n' "$LAN_IP"
    printf 'LAN_NETMASK=%q\n' "$LAN_NETMASK"
    printf 'DHCP_START=%q\n' "$DHCP_START"
    printf 'DHCP_END=%q\n' "$DHCP_END"
    printf 'DHCP_LEASE=%q\n' "$DHCP_LEASE"
  } > "$ROUTER_CONF"
}

interface_exists() {
  [ -n "$1" ] && ip link show "$1" >/dev/null 2>&1
}

detect_lan_interface() {
  local iface iface_path

  if command -v iw >/dev/null 2>&1; then
    while IFS= read -r iface; do
      if interface_exists "$iface"; then
        printf '%s\n' "$iface"
        return 0
      fi
    done < <(iw dev 2>/dev/null | awk '$1 == "Interface" { print $2 }')
  fi

  for iface_path in /sys/class/net/*; do
    [ -d "$iface_path" ] || continue
    iface=${iface_path##*/}
    [ "$iface" = "lo" ] && continue
    if [ -d "$iface_path/wireless" ] && interface_exists "$iface"; then
      printf '%s\n' "$iface"
      return 0
    fi
  done

  return 1
}

validate_interfaces() {
  local updated=0 detected_lan

  if ! interface_exists "$LAN_INTERFACE"; then
    if detected_lan=$(detect_lan_interface); then
      echo "Configured LAN interface '$LAN_INTERFACE' not found; using '$detected_lan'." >&2
      LAN_INTERFACE="$detected_lan"
      updated=1
    else
      echo "Error: Configured LAN interface '$LAN_INTERFACE' not found and no wireless interface was detected." >&2
      return 1
    fi
  fi

  if [ "$updated" -eq 1 ]; then
    write_router_conf
  fi
}

mkdir -p "$CONFIG_DIR" "$LEASES_DIR" "$LOGS_DIR"

if [ -f "$ROUTER_CONF" ]; then
  load_router_conf
else
  WAN_INTERFACE="${WAN_INTERFACE:-eth0}"
  LAN_INTERFACE="${LAN_INTERFACE:-wlan0}"
  SSID="${SSID:-WiFiRouter}"
  WPA_PASSPHRASE="${WPA_PASSPHRASE:-changeme123}"
  CHANNEL="${CHANNEL:-6}"
  LAN_IP="${LAN_IP:-192.168.50.1}"
  LAN_NETMASK="${LAN_NETMASK:-255.255.255.0}"
  DHCP_START="${DHCP_START:-192.168.50.100}"
  DHCP_END="${DHCP_END:-192.168.50.200}"
  DHCP_LEASE="${DHCP_LEASE:-12h}"

  write_router_conf
fi

WAN_INTERFACE="${WAN_INTERFACE:-eth0}"
LAN_INTERFACE="${LAN_INTERFACE:-wlan0}"
SSID="${SSID:-WiFiRouter}"
WPA_PASSPHRASE="${WPA_PASSPHRASE:-changeme123}"
CHANNEL="${CHANNEL:-6}"
LAN_IP="${LAN_IP:-192.168.50.1}"
LAN_NETMASK="${LAN_NETMASK:-255.255.255.0}"
DHCP_START="${DHCP_START:-192.168.50.100}"
DHCP_END="${DHCP_END:-192.168.50.200}"
DHCP_LEASE="${DHCP_LEASE:-12h}"
DNS_PORT="${DNS_PORT:-53}"
DNS_SERVER="${DNS_SERVER:-$LAN_IP}"

if snap_value="$(snapctl_get dns.port)"; then
  DNS_PORT="$snap_value"
fi

if snap_value="$(snapctl_get dns.server)"; then
  DNS_SERVER="$snap_value"
fi

case "$DNS_PORT" in
  ''|*[!0-9]*)
    echo "Invalid dns.port '$DNS_PORT'; using 53." >&2
    DNS_PORT=53
    ;;
esac

if [ "$DNS_PORT" -gt 65535 ]; then
  echo "Invalid dns.port '$DNS_PORT'; using 53." >&2
  DNS_PORT=53
fi

validate_interfaces

if [ -f "$TEMPLATE_CONF" ]; then
  sed \
    -e "s|{{LAN_INTERFACE}}|$LAN_INTERFACE|g" \
    -e "s|{{DHCP_START}}|$DHCP_START|g" \
    -e "s|{{DHCP_END}}|$DHCP_END|g" \
    -e "s|{{LAN_NETMASK}}|$LAN_NETMASK|g" \
    -e "s|{{DHCP_LEASE}}|$DHCP_LEASE|g" \
    -e "s|{{LAN_IP}}|$LAN_IP|g" \
    -e "s|{{DNS_PORT}}|$DNS_PORT|g" \
    -e "s|{{DNS_SERVER}}|$DNS_SERVER|g" \
    -e "s|{{LEASE_FILE}}|$LEASES_DIR/dnsmasq.leases|g" \
    -e "s|{{LOG_FILE}}|$LOGS_DIR/dnsmasq.log|g" \
    "$TEMPLATE_CONF" > "$DNSMASQ_CONF"
else
  cat > "$DNSMASQ_CONF" <<EOF
interface=$LAN_INTERFACE
bind-interfaces
except-interface=lo
port=$DNS_PORT
server=8.8.8.8
server=8.8.4.4
domain-needed
bogus-priv
dhcp-range=$DHCP_START,$DHCP_END,$LAN_NETMASK,$DHCP_LEASE
dhcp-option=option:router,$LAN_IP
dhcp-option=option:dns-server,$DNS_SERVER
dhcp-leasefile=$LEASES_DIR/dnsmasq.leases
log-dhcp
log-queries
log-facility=$LOGS_DIR/dnsmasq.log
EOF
fi

exec "$SNAP/usr/sbin/dnsmasq" --conf-file="$DNSMASQ_CONF" --no-daemon
