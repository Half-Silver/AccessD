#!/bin/bash

# Status script for WiFi Router

SNAP_COMMON=${SNAP_COMMON:-/var/snap/accessd/common}
CONFIG_DIR="$SNAP_COMMON/config"
LEASES_DIR="$SNAP_COMMON/leases"
ROUTER_CONF="$CONFIG_DIR/router.conf"

load_router_conf() {
    if [ ! -f "$ROUTER_CONF" ]; then
        return 0
    fi

    # shellcheck disable=SC1090
    if . "$ROUTER_CONF" 2>/dev/null; then
        return 0
    fi

    while IFS= read -r line; do
        case "$line" in
            ''|\#*)
                continue
                ;;
            *=*)
                key=${line%%=*}
                val=${line#*=}
                case "$val" in
                    ""*"") val=${val#\"}; val=${val%\"} ;;
                    \'.*\') val=${val#\'}; val=${val%\'} ;;
                esac
                val=${val//\\ / }
                val=${val//\\\\/\\}
                case "$key" in
                    WAN_INTERFACE) WAN_INTERFACE="$val" ;;
                    LAN_INTERFACE) LAN_INTERFACE="$val" ;;
                    SSID) SSID="$val" ;;
                    WPA_PASSPHRASE) WPA_PASSPHRASE="$val" ;;
                    CHANNEL) CHANNEL="$val" ;;
                    LAN_IP) LAN_IP="$val" ;;
                    LAN_NETMASK) LAN_NETMASK="$val" ;;
                    DHCP_START) DHCP_START="$val" ;;
                    DHCP_END) DHCP_END="$val" ;;
                    DHCP_LEASE) DHCP_LEASE="$val" ;;
                esac
                ;;
        esac
    done < "$ROUTER_CONF"
}

echo "WiFi Router Status"
echo "=================="
echo ""

# Load configuration
if [ -f "$ROUTER_CONF" ]; then
    load_router_conf
    
    echo "Configuration:"
    echo "  SSID: $SSID"
    echo "  Channel: $CHANNEL"
    echo "  LAN Interface: $LAN_INTERFACE"
    echo "  WAN Interface: $WAN_INTERFACE"
    echo "  LAN IP: $LAN_IP"
    echo "  DHCP Range: $DHCP_START - $DHCP_END"
    echo ""
else
    echo "No configuration found."
    echo ""
fi

# Check if interfaces exist
echo "Network Interfaces:"
if ip link show "$WAN_INTERFACE" &>/dev/null; then
    echo "  ✓ WAN Interface ($WAN_INTERFACE) exists"
else
    echo "  ✗ WAN Interface ($WAN_INTERFACE) not found"
fi

if ip link show "$LAN_INTERFACE" &>/dev/null; then
    echo "  ✓ LAN Interface ($LAN_INTERFACE) exists"
    
    # Check if it's up
    if ip link show "$LAN_INTERFACE" | grep -q "state UP"; then
        echo "    Status: UP"
    else
        echo "    Status: DOWN"
    fi
    
    # Show IP address
    LAN_IP_ACTUAL=$(ip addr show "$LAN_INTERFACE" | grep "inet " | awk '{print $2}')
    if [ -n "$LAN_IP_ACTUAL" ]; then
        echo "    IP: $LAN_IP_ACTUAL"
    fi
else
    echo "  ✗ LAN Interface ($LAN_INTERFACE) not found"
fi
echo ""

# Check if processes are running
echo "Services:"
if pgrep -f "(/usr/sbin/hostapd|/snap/.*/usr/sbin/hostapd).*hostapd\.conf" &>/dev/null; then
    echo "  ✓ hostapd (WiFi Access Point) is running"
else
    echo "  ✗ hostapd is not running"
fi

if pgrep -f "(/usr/sbin/dnsmasq|/snap/.*/usr/sbin/dnsmasq).*dnsmasq\.conf" &>/dev/null; then
    echo "  ✓ dnsmasq (DHCP/DNS) is running"
else
    echo "  ✗ dnsmasq is not running"
fi

if pgrep -f "(accessd\.web-ui|web-ui-raspap-daemon|web-ui-raspap-router\.php)" &>/dev/null; then
    echo "  ✓ web-ui (Router Dashboard) is running"
else
    echo "  ✗ web-ui is not running"
fi
echo ""

# Check IP forwarding
echo "Routing:"
if [ "$(cat /proc/sys/net/ipv4/ip_forward)" = "1" ]; then
    echo "  ✓ IP forwarding enabled"
else
    echo "  ✗ IP forwarding disabled"
fi

# Check NAT rules
IPTABLES_BIN="iptables"
if [ -n "$SNAP" ] && [ -x "$SNAP/usr/sbin/iptables" ]; then
    IPTABLES_BIN="$SNAP/usr/sbin/iptables"
fi

if "$IPTABLES_BIN" -t nat -L POSTROUTING -n | grep -q MASQUERADE; then
    echo "  ✓ NAT rules configured"
else
    echo "  ✗ NAT rules not found"
fi
echo ""

# Show connected clients (if dnsmasq is running)
if [ -f "$LEASES_DIR/dnsmasq.leases" ]; then
    CLIENTS=$(wc -l < "$LEASES_DIR/dnsmasq.leases")
    echo "Connected Clients: $CLIENTS"
    if [ "$CLIENTS" -gt 0 ]; then
        echo ""
        awk '{print "  " $2 " - " $3 " (" $4 ")"}' "$LEASES_DIR/dnsmasq.leases"
    fi
fi
