#!/bin/bash
set -e

SNAP=${SNAP:-/snap/accessd/current}
SNAP_COMMON=${SNAP_COMMON:-/var/snap/accessd/common}

CONFIG_DIR="$SNAP_COMMON/config"
LEASES_DIR="$SNAP_COMMON/leases"
LOGS_DIR="$SNAP_COMMON/logs"

mkdir -p "$CONFIG_DIR" "$LEASES_DIR" "$LOGS_DIR"

ROUTER_CONF="$CONFIG_DIR/router.conf"

snapctl_get() {
  local key="$1"
  local value

  value="$(snapctl get "$key" 2>/dev/null || true)"
  case "$value" in
    ''|null)
      return 1
      ;;
    *)
      printf '%s\n' "$value"
      return 0
      ;;
  esac
}

load_router_conf() {
  if [ ! -f "$ROUTER_CONF" ]; then
    return 0
  fi

  # shellcheck disable=SC1090
  if . "$ROUTER_CONF" 2>/dev/null; then
    return 0
  fi

  while IFS= read -r line; do
    case "$line" in
      ''|\#*)
        continue
        ;;
      *=*)
        key=${line%%=*}
        val=${line#*=}
        case "$val" in
          ""*"") val=${val#\"}; val=${val%\"} ;;
          \'.*\') val=${val#\'}; val=${val%\'} ;;
        esac
        val=${val//\\ / }
        val=${val//\\\\/\\}
        case "$key" in
          WAN_INTERFACE) WAN_INTERFACE="$val" ;;
          LAN_INTERFACE) LAN_INTERFACE="$val" ;;
          SSID) SSID="$val" ;;
          WPA_PASSPHRASE) WPA_PASSPHRASE="$val" ;;
          CHANNEL) CHANNEL="$val" ;;
          LAN_IP) LAN_IP="$val" ;;
          LAN_NETMASK) LAN_NETMASK="$val" ;;
          DHCP_START) DHCP_START="$val" ;;
          DHCP_END) DHCP_END="$val" ;;
          DHCP_LEASE) DHCP_LEASE="$val" ;;
        esac
        ;;
    esac
  done < "$ROUTER_CONF"
}

write_router_conf() {
  {
    printf 'WAN_INTERFACE=%q\n' "$WAN_INTERFACE"
    printf 'LAN_INTERFACE=%q\n' "$LAN_INTERFACE"
    printf 'SSID=%q\n' "$SSID"
    printf 'WPA_PASSPHRASE=%q\n' "$WPA_PASSPHRASE"
    printf 'CHANNEL=%q\n' "$CHANNEL"
    printf 'LAN_IP=%q\n' "$LAN_IP"
    printf 'LAN_NETMASK=%q\n' "$LAN_NETMASK"
    printf 'DHCP_START=%q\n' "$DHCP_START"
    printf 'DHCP_END=%q\n' "$DHCP_END"
    printf 'DHCP_LEASE=%q\n' "$DHCP_LEASE"
  } > "$ROUTER_CONF"
}

if [ ! -f "$ROUTER_CONF" ]; then
  cp "$SNAP/etc/accessd/router.conf.default" "$ROUTER_CONF"
fi

load_router_conf

NEW_SSID=$(snapctl_get wifi.ssid || true)
NEW_PASSWORD=$(snapctl_get wifi.password || true)
NEW_CHANNEL=$(snapctl_get wifi.channel || true)
NEW_WAN_INTERFACE=$(snapctl_get network.wan-interface || true)
NEW_LAN_INTERFACE=$(snapctl_get network.lan-interface || true)
NEW_LAN_IP=$(snapctl_get network.lan-ip || true)
NEW_DHCP_START=$(snapctl_get dhcp.start || true)
NEW_DHCP_END=$(snapctl_get dhcp.end || true)
NEW_DHCP_LEASE=$(snapctl_get dhcp.lease || true)
NEW_DNS_PORT=$(snapctl_get dns.port || true)
NEW_DNS_SERVER=$(snapctl_get dns.server || true)

[ -n "$NEW_SSID" ] && SSID="$NEW_SSID"
[ -n "$NEW_PASSWORD" ] && WPA_PASSPHRASE="$NEW_PASSWORD"
[ -n "$NEW_CHANNEL" ] && CHANNEL="$NEW_CHANNEL"
[ -n "$NEW_WAN_INTERFACE" ] && WAN_INTERFACE="$NEW_WAN_INTERFACE"
[ -n "$NEW_LAN_INTERFACE" ] && LAN_INTERFACE="$NEW_LAN_INTERFACE"
[ -n "$NEW_LAN_IP" ] && LAN_IP="$NEW_LAN_IP"
[ -n "$NEW_DHCP_START" ] && DHCP_START="$NEW_DHCP_START"
[ -n "$NEW_DHCP_END" ] && DHCP_END="$NEW_DHCP_END"
[ -n "$NEW_DHCP_LEASE" ] && DHCP_LEASE="$NEW_DHCP_LEASE"

write_router_conf

DNS_PORT="${NEW_DNS_PORT:-53}"
DNS_SERVER="${NEW_DNS_SERVER:-$LAN_IP}"

case "$DNS_PORT" in
  ''|*[!0-9]*)
    DNS_PORT=53
    ;;
esac

if [ "$DNS_PORT" -gt 65535 ]; then
  DNS_PORT=53
fi

sed \
  -e "s|{{LAN_INTERFACE}}|$LAN_INTERFACE|g" \
  -e "s|{{SSID}}|$SSID|g" \
  -e "s|{{CHANNEL}}|$CHANNEL|g" \
  -e "s|{{WPA_PASSPHRASE}}|$WPA_PASSPHRASE|g" \
  "$SNAP/etc/accessd/hostapd.conf.template" > "$CONFIG_DIR/hostapd.conf"

sed \
  -e "s|{{LAN_INTERFACE}}|$LAN_INTERFACE|g" \
  -e "s|{{DHCP_START}}|$DHCP_START|g" \
  -e "s|{{DHCP_END}}|$DHCP_END|g" \
  -e "s|{{LAN_NETMASK}}|$LAN_NETMASK|g" \
  -e "s|{{DHCP_LEASE}}|$DHCP_LEASE|g" \
  -e "s|{{LAN_IP}}|$LAN_IP|g" \
  -e "s|{{DNS_PORT}}|$DNS_PORT|g" \
  -e "s|{{DNS_SERVER}}|$DNS_SERVER|g" \
  -e "s|{{LEASE_FILE}}|$LEASES_DIR/dnsmasq.leases|g" \
  -e "s|{{LOG_FILE}}|$LOGS_DIR/dnsmasq.log|g" \
  "$SNAP/etc/accessd/dnsmasq.conf.template" > "$CONFIG_DIR/dnsmasq.conf"

snapctl restart accessd.daemon 2>/dev/null || true
snapctl restart accessd.dnsmasq 2>/dev/null || true
snapctl restart accessd.hostapd 2>/dev/null || true
snapctl restart accessd.web-ui 2>/dev/null || true
